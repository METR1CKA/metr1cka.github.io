---
title: Configuraciones adicionales
date: 2025-02-11
categories: [Extras]
tags: [Extras]
---

## Introducción

En este artículo se recopilan diversas configuraciones adicionales que te ayudarán a mejorar la seguridad y el manejo de procesos en tu servidor. Veremos la instalación de Certbot para gestionar certificados SSL, la configuración de PM2 para la administración de procesos Node.js, la instalación de Node.js y la aplicación de reglas de firewall para puertos HTTP/HTTPS. Además, se muestra cómo configurar PM2 para tareas programadas.

---

## 1. Instalación de Certbot para certificados SSL

Certbot es una herramienta de código abierto que automatiza la obtención de certificados SSL/TLS para tu servidor web. En este caso, se instalará Certbot con el plugin DNS de Cloudflare para gestionar los certificados SSL mediante la API de Cloudflare.

### 1.1 Instalar snapd

1. **Instalar y actualizar repositorios:**

   ```console
   sudo dnf install epel-release
   sudo dnf upgrade
   ```

2. **Instalar snapd:**

   ```console
   sudo yum install snapd
   ```

3. **Habilitar el socket de snapd y crear enlace simbólico:**

   ```console
   systemctl enable --now snapd.socket
   ln -s /var/lib/snapd/snap /snap
   ```

### 1.2 Configurar e instalar Certbot con Snap

1. **Instalar y actualizar el core de snap:**

   ```console
   snap install core
   snap refresh core
   ```

2. **Instalar Certbot en modo clásico:**

   ```console
   snap install --classic certbot
   ln -s /snap/bin/certbot /usr/bin/certbot
   snap set certbot trust-plugin-with-root=ok
   ```

### 1.3 Instalar el plugin DNS para Cloudflare y configurar token

1. **Instalar el plugin DNS:**

   ```console
   snap install certbot-dns-cloudflare
   ```

2. **Crear el archivo de configuración para el token:**

   ```console
   mkdir -p ~/.secrets/certbot
   cd ~/.secrets/certbot
   nano init-cloudflare.ini
   ```

3. **Agregar la siguiente línea al archivo `init-cloudflare.ini`:**

   ```ini
   dns_cloudflare_api_token = token
   ```
   {: file='init-cloudflare.ini'}

4. **Asegurar permisos de acceso al archivo:**

   ```console
   chmod 600 init-cloudflare.ini
   ```

### 1.4 Generar certificados SSL con Certbot y el plugin Cloudflare

1. **Ejecutar Certbot para obtener los certificados:**

   ```console
   certbot certonly --dns-cloudflare --preferred-challenges dns --dns-cloudflare-credentials ~/.secrets/certbot/init-cloudflare.ini -d domain.com -d admin-domain.com -d api-domain.com
   ```

### 1.5 Configurar parámetros SSL adicionales

1. **Generar parámetros Diffie-Hellman:**

   ```console
   sudo openssl dhparam -out /etc/ssl/certs/dhparam.pem 2048
   ```

2. **Rutas de archivos PEM para la configuración de Nginx:**

   - `/etc/letsencrypt/live/domain.com/fullchain.pem`
   - `/etc/letsencrypt/live/domain.com/privkey.pem`

---

## 2. Instalación de PM2 para manejo de procesos Node.js

PM2 es un administrador de procesos de producción para aplicaciones Node.js con un equilibrio entre características y simplicidad. En este caso, se instalará PM2 globalmente para gestionar la API y tareas programadas.

### 2.1 Instalar PM2 globalmente

1. **Ejecutar el siguiente comando como root para instalar PM2:**

   ```console
   npm install pm2@latest -g
   ```

---

## 3. Instalación y Configuración de Node.js

Node.js es un entorno de ejecución de JavaScript que permite ejecutar código JavaScript en el servidor. En este caso, se instalará Node.js v18 y se aplicarán reglas de firewall para puertos HTTP y HTTPS.

### 3.1 Seleccionar la versión deseada

- **Comando alternativo (para versiones antiguas):**

  ```console
  # curl -fsSL https://rpm.nodesource.com/setup_noversion.x | bash -
  # curl -fsSL https://rpm.nodesource.com/setup_14.x | bash -
  ```

### 3.2 Instalar Node.js v18

1. **Instalar el repositorio para Node.js v18:**

   ```console
   sudo yum install https://rpm.nodesource.com/pub_18.x/nodistro/repo/nodesource-release-nodistro-1.noarch.rpm -y
   ```

2. **Instalar Node.js:**

   ```console
   sudo yum install nodejs -y --setopt=nodesource-nodejs.module_hotfixes=1
   ```

## 4. Reglas de firewall para puertos HTTP y HTTPS (API Digital Ocean)

Utiliza las siguientes reglas (enviadas a la API de Digital Ocean) para permitir tráfico en el puerto 443:

   ```js
   {
       "inbound_rules": [
           {
               "protocol": "tcp",
               // "ports": "443", HTTPS
               // "ports": "80", HTTP
               "ports": "443",
               "sources": {
                   "addresses": [
                       "173.245.48.0/20",
                       "103.21.244.0/22",
                       "103.22.200.0/22",
                       "103.31.4.0/22",
                       "141.101.64.0/18",
                       "108.162.192.0/18",
                       "190.93.240.0/20",
                       "188.114.96.0/20",
                       "197.234.240.0/22",
                       "198.41.128.0/17",
                       "162.158.0.0/15",
                       "172.64.0.0/13",
                       "131.0.72.0/22",
                       "104.16.0.0/13",
                       "104.24.0.0/14"
                   ]
               }
           }
       ]
   }
   ```

---

## 5. Configuración de PM2 para la API y tareas programadas

### 5.1 Arrancar la API con PM2

1. **Iniciar la API con opciones de reinicio y límite de memoria:**

   ```console
   pm2 start server.js --name=api --max-memory-restart 512M -i 1
   ```

2. **Para múltiples CPUs:**

   ```console
   pm2 start server.js --name=api --max-memory-restart 768M -i max
   ```

### 5.2 Monitorear y configurar el arranque en reinicios

1. **Monitorear procesos:**

   ```console
   pm2 monit
   ```

2. **Configurar PM2 para iniciar automáticamente en reinicios:**

   ```console
   pm2 startup
   sudo env PATH=$PATH:/usr/bin /usr/lib/node_modules/pm2/bin/pm2 startup systemd -u Us3Rb31SB0l --hp /home/Us3Rb31SB0l
   pm2 save
   pm2 update
   pm2 monit
   ```

3. **Reiniciar el servidor para verificar el inicio automático:**

   ```console
   sudo reboot
   ```

## 6 Configuración de PM2 para tareas programadas

1. **Ejemplo de configuración en un archivo JavaScript (por ejemplo, `ecosystem.config.js`):**

   ```js
   module.exports = {
     apps: [
       {
         name: "scheduler",
         script: "node",
         args: "ace scheduler:run",
         interpreter: "none",
         watch: false,
         max_memory_restart: "256M",
         instances: 1,
       },
     ],
   }
   ```

2. **Iniciar tareas programadas con PM2:**

   ```console
   pm2 start ./ace -- run:scheduler
   pm2 start filesource_script --name "{app_name}" -- run {script_name}
   pm2 start node --interpreter=node --interpreter-args="ace scheduler:run" --name=scheduler --max-memory-restart 1G -i 1
   ```

---

## Conclusión

Con estas configuraciones adicionales has instalado y configurado Certbot para gestionar certificados SSL mediante Cloudflare, instalado PM2 y Node.js para el manejo de procesos, y aplicado reglas de firewall para proteger tu servidor. Además, se incluye un ejemplo para la ejecución de tareas programadas con PM2.

> Cualquier duda o comentario, agregarla en la sección de comentarios abajo de cada publicación.
{: .prompt-tip }
