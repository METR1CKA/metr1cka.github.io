---
title: SSH
date: 2025-01-15
categories: [Digital Ocean, VPS, Linux, SSH]
tags: [Digital Ocean, VPS, Linux, SSH]
---

## Introducción

**SSH** (Secure Shell) es un protocolo de red que nos permite acceder de manera segura a un servidor remoto. Gracias a SSH, podemos administrar nuestros servidores de forma eficiente, con una conexión cifrada que garantiza la seguridad de los datos que manejamos. 

En este tutorial, vamos a aprender a configurar SSH en dos servidores VPS o droplets de **DigitalOcean**, específicamente para permitir conexiones SSH en puertos diferentes para cada servidor, mejorando así la seguridad al evitar ataques de fuerza bruta.

---

## 1. Configuración Básica de SSH

### Cambiar el Puerto de Escucha

- Para comenzar, editamos el archivo `/etc/ssh/sshd_config` para cambiar el puerto de escucha del servicio SSH en cada servidor.

~~~
nano /etc/ssh/sshd_config
~~~

- Cambia el puerto de escucha para el **Droplet 1**. Puedes elegir cualquier puerto que no esté en uso, pero en este caso, usaremos el **puerto 55113**:

~~~
Port 55113
~~~

- Luego, repite este paso para el **Droplet 2**, pero asigna el **puerto 60112**:

~~~
Port 60112
~~~

### Reiniciar el Servicio SSH

Una vez cambiados los puertos, necesitamos reiniciar el servicio de SSH para que los cambios surtan efecto:

- Ejecuta el siguiente comando:

~~~
systemctl restart sshd
~~~

O si prefieres usar el antiguo comando:

~~~
service sshd restart
~~~

- Para verificar que el servicio SSH esté corriendo correctamente:

~~~
systemctl status sshd
~~~

O si prefieres usar el antiguo comando:

~~~
service sshd status
~~~

> Ambos comandos hacen lo mismo, no te preocupes por cuál usar.
{: .prompt-tip}

---

## 2. Crear un Usuario para Acceso SSH

Una vez que el puerto esté configurado correctamente, debemos crear un usuario distinto a **root** para poder acceder a través de SSH.

- Para crear un nuevo usuario, utiliza el siguiente comando:

~~~
adduser {user}
~~~

- Después, asigna una contraseña al usuario:

~~~
passwd {user}
~~~

- Si necesitas borrar el usuario en el futuro:

~~~
userdel -r {user}
~~~

- Si quieres darle acceso **sudo** al usuario, añádelo al grupo **wheel**:

~~~
gpasswd -a {user} wheel
~~~

- Si en algún momento deseas eliminarlo de este grupo:

~~~
gpasswd -d {user} wheel
~~~

- Es recomendable cambiar la propiedad del directorio **home** al nuevo usuario (esto se hace como **root** antes de cambiar al usuario creado):

~~~
chown -R {user}:{user} /home/{user}
~~~

- Para probar el acceso, cambia al usuario recién creado:

~~~
su {user}
~~~

- Luego, dirígete al directorio home del usuario:

~~~
cd
~~~

- Para salir del usuario creado:

~~~
exit
~~~

> Recuerda que los usuarios creados solo podrán conectarse por **SSH**, asegúrate de configurar bien los accesos.
{: .prompt-warning}

---

## 3. Configuración de la Clave SSH y Acceso entre Servidores

Ahora, vamos a configurar el acceso entre los servidores usando claves SSH para que podamos conectarnos de manera más segura.

### Crear la Carpeta .ssh y el Archivo authorized_keys

- Primero, crea la carpeta `.ssh` en ambos **droplets**:

~~~
mkdir .ssh
cd $_
~~~

- Si prefieres usar otro nombre de carpeta, puedes hacerlo, pero recuerda que la ruta debe estar dentro del directorio home del usuario:

~~~
mkdir ~/{carpeta}
cd $_
~~~

- Luego, crea el archivo `authorized_keys` donde se guardará la clave pública para la conexión SSH:

~~~
touch authorized_keys
~~~

> Nota: Puedes copiar el archivo `authorized_keys` de **root** a la carpeta `.ssh` de tu usuario creado si ya tienes configuradas las claves en **root**.
{: .prompt-tip}

- Para copiar la clave pública de **root**:

~~~
cat /root/.ssh/authorized_keys > ~/{ruta_ssh}/authorized_keys
~~~

O si el archivo `authorized_keys` no existe, puedes copiarlo directamente:

~~~
cp /root/.ssh/authorized_keys ~/{ruta_ssh}/authorized_keys
~~~

- Luego, asegúrate de asignar los permisos adecuados a la carpeta y archivo:

~~~
chmod 700 -R ~/{ruta_ssh}
chmod 600 ~/{ruta_ssh}/authorized_keys
~~~

---

## 4. Configuración del SSH para Usuarios Específicos

Ahora que ya tenemos la clave SSH configurada, vamos a editar el archivo de configuración **sshd_config** para permitir que solo ciertos usuarios puedan conectarse mediante SSH.

- Abre el archivo `/etc/ssh/sshd_config`:

~~~
nano /etc/ssh/sshd_config
~~~

- Añade las siguientes líneas para especificar los usuarios permitidos y otras configuraciones de seguridad:

~~~
AddressFamily inet
PermitRootLogin no
AllowUsers {user}
MaxAuthTries 3
MaxSessions 3
~~~

> Asegúrate de reemplazar `{user}` por el nombre de usuario que hayas creado.
{: .prompt-warning}
